#!/bin/sh
# ----------------------------------------------------------------------------
# Licensed to the Apache Software Foundation (ASF) under one
# or more contributor license agreements.  See the NOTICE file
# distributed with this work for additional information
# regarding copyright ownership.  The ASF licenses this file
# to you under the Apache License, Version 2.0 (the
# "License"); you may not use this file except in compliance
# with the License.  You may obtain a copy of the License at
#
#    http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing,
# software distributed under the License is distributed on an
# "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
# KIND, either express or implied.  See the License for the
# specific language governing permissions and limitations
# under the License.
# ----------------------------------------------------------------------------

# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup batch script, version 3.3.4
#
# Optional ENV vars
# -----------------
#   JAVA_HOME - location of a JDK home dir, required when download maven via java source
#   MVNW_REPOURL - repo url base for downloading maven distribution
#   MVNW_USERNAME/MVNW_PASSWORD - user and password for downloading maven
#   MVNW_VERBOSE - true: enable verbose log; debug: trace the mvnw script; others: silence the output
# ----------------------------------------------------------------------------

#!/bin/sh
# ----------------------------------------------------------------------------
# Apache Maven Wrapper startup script (SECURITY HARDENED)
# ----------------------------------------------------------------------------

set -euf
[ "${MVNW_VERBOSE-}" != debug ] || set -x

# ---------------------------------------------------------------------------
# SECURITY HARDENING — PATH SANITIZATION (anti PATH injection)
# ---------------------------------------------------------------------------
PATH=/usr/bin:/bin:/usr/sbin:/sbin
export PATH

# OS specific support.
native_path() { printf %s\\n "$1"; }
case "$(uname)" in
CYGWIN* | MINGW*)
  [ -z "${JAVA_HOME-}" ] || JAVA_HOME="$(cygpath --unix "$JAVA_HOME")"
  native_path() { cygpath --path --windows "$1"; }
  ;;
esac

set_java_home() {
  if [ -n "${JAVA_HOME-}" ]; then
    if [ -x "$JAVA_HOME/jre/sh/java" ]; then
      JAVACMD="$JAVA_HOME/jre/sh/java"
      JAVACCMD="$JAVA_HOME/jre/sh/javac"
    else
      JAVACMD="$JAVA_HOME/bin/java"
      JAVACCMD="$JAVA_HOME/bin/javac"
      if [ ! -x "$JAVACMD" ] || [ ! -x "$JAVACCMD" ]; then
        echo "JAVA_HOME is not defined correctly." >&2
        return 1
      fi
    fi
  else
    JAVACMD="$(command -v java || true)"
    JAVACCMD="$(command -v javac || true)"
    if [ ! -x "${JAVACMD-}" ] || [ ! -x "${JAVACCMD-}" ]; then
      echo "java/javac not found." >&2
      return 1
    fi
  fi
}

hash_string() {
  str="${1:-}" h=0
  while [ -n "$str" ]; do
    char="${str%"${str#?}"}"
    h=$(((h * 31 + $(LC_CTYPE=C printf %d "'$char")) % 4294967296))
    str="${str#?}"
  done
  printf %x\\n $h
}

verbose() { :; }
[ "${MVNW_VERBOSE-}" != true ] || verbose() { printf %s\\n "${1-}"; }

die() {
  printf %s\\n "$1" >&2
  exit 1
}

trim() {
  printf "%s" "${1}" | tr -d '[:space:]'
}

scriptDir="$(dirname "$0")"
scriptName="$(basename "$0")"

# ---------------------------------------------------------------------------
# Parse maven-wrapper.properties
# ---------------------------------------------------------------------------
while IFS="=" read -r key value; do
  case "${key-}" in
  distributionUrl) distributionUrl=$(trim "${value-}") ;;
  distributionSha256Sum) distributionSha256Sum=$(trim "${value-}") ;;
  esac
done <"$scriptDir/.mvn/wrapper/maven-wrapper.properties"

[ -n "${distributionUrl-}" ] || die "distributionUrl missing"

# ---------------------------------------------------------------------------
# SECURITY HARDENING — HTTPS ONLY
# ---------------------------------------------------------------------------
case "$distributionUrl" in
  https://*) ;;
  *)
    die "Security error: distributionUrl must use HTTPS"
    ;;
esac

# ---------------------------------------------------------------------------
# SECURITY HARDENING — SHA256 IS MANDATORY
# ---------------------------------------------------------------------------
[ -n "${distributionSha256Sum-}" ] || die "Security error: distributionSha256Sum is mandatory"

case "${distributionUrl##*/}" in
maven-mvnd-*bin.*)
  MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/
  ;;
maven-mvnd-*)
  MVN_CMD=mvnd.sh _MVNW_REPO_PATTERN=/maven/mvnd/
  ;;
*)
  MVN_CMD="mvn${scriptName#mvnw}" _MVNW_REPO_PATTERN=/org/apache/maven/
  ;;
esac

[ -z "${MVNW_REPOURL-}" ] || distributionUrl="$MVNW_REPOURL$_MVNW_REPO_PATTERN${distributionUrl#*"$_MVNW_REPO_PATTERN"}"

distributionUrlName="${distributionUrl##*/}"
distributionUrlNameMain="${distributionUrlName%.*}"
distributionUrlNameMain="${distributionUrlNameMain%-bin}"

MAVEN_USER_HOME="${MAVEN_USER_HOME:-${HOME}/.m2}"
MAVEN_HOME="${MAVEN_USER_HOME}/wrapper/dists/${distributionUrlNameMain}/$(hash_string "$distributionUrl")"

exec_maven() {
  export MVNW_USERNAME=
  export MVNW_PASSWORD=
  unset MVNW_VERBOSE MVNW_USERNAME MVNW_PASSWORD MVNW_REPOURL || :
  exec "$MAVEN_HOME/bin/$MVN_CMD" "$@" || die "cannot exec maven"
}

if [ -d "$MAVEN_HOME" ]; then
  exec_maven "$@"
fi

# ---------------------------------------------------------------------------
# Prepare temp directory
# ---------------------------------------------------------------------------
TMP_DOWNLOAD_DIR="$(mktemp -d)" || die "cannot create temp dir"
clean() { rm -rf -- "$TMP_DOWNLOAD_DIR"; }
trap clean HUP INT TERM EXIT

mkdir -p -- "${MAVEN_HOME%/*}"

# ---------------------------------------------------------------------------
# Download Maven
# ---------------------------------------------------------------------------
if command -v curl >/dev/null; then
  curl -f -L -o "$TMP_DOWNLOAD_DIR/$distributionUrlName" "$distributionUrl"
elif command -v wget >/dev/null; then
  wget "$distributionUrl" -O "$TMP_DOWNLOAD_DIR/$distributionUrlName"
else
  set_java_home || die "java not available"
  javaSource="$TMP_DOWNLOAD_DIR/Downloader.java"
  cat >"$javaSource" <<-END
	public class Downloader {
	  public static void main(String[] args) throws Exception {
	    java.nio.file.Files.copy(
	      java.net.URI.create(args[0]).toURL().openStream(),
	      java.nio.file.Paths.get(args[1])
	    );
	  }
	}
	END
  "$JAVACCMD" "$javaSource"
  "$JAVACMD" -cp "$TMP_DOWNLOAD_DIR" Downloader "$distributionUrl" "$TMP_DOWNLOAD_DIR/$distributionUrlName"
fi

# ---------------------------------------------------------------------------
# Verify SHA-256
# ---------------------------------------------------------------------------
echo "$distributionSha256Sum  $TMP_DOWNLOAD_DIR/$distributionUrlName" | sha256sum -c - >/dev/null \
  || die "SHA-256 verification failed"

# ---------------------------------------------------------------------------
# Extract
# ---------------------------------------------------------------------------
unzip "$TMP_DOWNLOAD_DIR/$distributionUrlName" -d "$TMP_DOWNLOAD_DIR"

actualDistributionDir="$(ls "$TMP_DOWNLOAD_DIR" | head -n 1)"
mv "$TMP_DOWNLOAD_DIR/$actualDistributionDir" "$MAVEN_HOME"

# ---------------------------------------------------------------------------
# SECURITY HARDENING — FILE PERMISSIONS
# ---------------------------------------------------------------------------
chmod -R u+rx "$MAVEN_HOME"
chmod -R go-rwx "$MAVEN_HOME"

exec_maven "$@"
